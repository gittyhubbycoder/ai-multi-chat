<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multi-AI Platform</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Markdown -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* ===================== BASE + MOBILE ===================== */
html,body{height:100%;margin:0}
body{transition:background .6s ease}

@media(max-width:768px){
  button,input,textarea{min-height:44px}
  .mobile-hide{display:none}
}

/* ===================== GLASS ===================== */
.glass{background:rgba(15,23,42,.55);backdrop-filter:blur(22px) saturate(160%);border:1px solid rgba(255,255,255,.18)}
.glass-dark{background:rgba(15,23,42,.7);backdrop-filter:blur(26px)}
.glass-card{background:rgba(15,23,42,.6);backdrop-filter:blur(24px);border-radius:1rem}
.glass-input{background:rgba(15,23,42,.7);border:1px solid rgba(255,255,255,.2)}
.glass-button{background:linear-gradient(135deg,#3b82f6,#60a5fa);transition:.25s}

/* ===================== MARKDOWN ===================== */
.markdown-content pre{background:rgba(0,0,0,.45);padding:1rem;border-radius:.75rem;overflow:auto;position:relative}
.markdown-content code{font-family:monospace}

/* Copy buttons */
.copy-btn{
  position:absolute;top:.5rem;right:.5rem;
  background:#111827;color:white;font-size:.7rem;
  padding:.25rem .5rem;border-radius:999px;cursor:pointer
}

/* ===================== SCROLL ===================== */
::-webkit-scrollbar{width:8px}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,.2);border-radius:4px}

/* ===================== ANIMATIONS ===================== */
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
.animate-bounce-1{animation:bounce 1s infinite}
.animate-bounce-2{animation:bounce 1s infinite .15s}
.animate-bounce-3{animation:bounce 1s infinite .3s}
</style>
</head>

<body data-glass="true">
<div id="app"></div>

<!-- React -->
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">

/* ===================== CONFIG ===================== */
const SUPABASE_URL='https://dagyncvbqirgnydsxahf.supabase.co';
const SUPABASE_ANON_KEY='YOUR_PUBLIC_ANON_KEY';
const ADMIN_EMAIL='jasimd931@gmail.com';
const INVITE_CODE='FAMILY2024';

const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

/* ===================== MODELS (ORIGINAL + NEW) ===================== */
const models=[
  {id:'gemini-pro',name:'Gemini 2.5 Pro',provider:'google',endpoint:'gemini-2.0-flash-exp',color:'#4285f4'},
  {id:'cerebras',name:'Cerebras Llama',provider:'cerebras',endpoint:'llama3.3-70b',color:'#8b5cf6'},
  {id:'groq',name:'Groq Llama',provider:'groq',endpoint:'llama-3.3-70b-versatile',color:'#ec4899'},
  {id:'deepseek',name:'DeepSeek V3',provider:'deepseek',endpoint:'deepseek-chat',color:'#10b981'},

  /* NEW */
  {id:'mistral',name:'Mistral Large',provider:'mistral',endpoint:'mistral-large-latest',color:'#f97316'},
  {id:'qwen',name:'Qwen Turbo',provider:'alibaba',endpoint:'qwen-turbo',color:'#38bdf8'}
];

/* ===================== HELPERS ===================== */
const estimateTokens=t=>Math.ceil((t||'').length/4);
const copyToClipboard=t=>navigator.clipboard.writeText(t);

/* Markdown renderer (code + full message copy compatible) */
marked.setOptions({breaks:true,gfm:true});
const renderMarkdown=(content)=>{
  let html=marked.parse(content||'');
  return html.replace(/<pre><code>([\s\S]*?)<\/code><\/pre>/g,(m,c)=>{
    const safe=c.replace(/`/g,'\\`');
    return `
      <div class="relative">
        <button class="copy-btn" onclick="navigator.clipboard.writeText(\`${safe}\`)">Copy</button>
        <pre><code>${c}</code></pre>
      </div>`;
  });
};

/* ===================== GRADIENTS ===================== */
const gradients={
  aurora:'linear-gradient(135deg,#667eea,#764ba2,#f093fb)',
  ocean:'linear-gradient(135deg,#2193b0,#6dd5ed)',
  sunset:'linear-gradient(135deg,#ff512f,#dd2476)',
  neon:'linear-gradient(135deg,#00f2fe,#4facfe)'
};

/* ===================== ICONS ===================== */
const SendIcon=()=>(
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
    <line x1="22" y1="2" x2="11" y2="13"/>
    <polygon points="22 2 15 22 11 13 2 9 22 2"/>
  </svg>
);

/* ===================== APP START ===================== */
const {useState,useEffect,useRef}=React;

function App(){

/* ---------- AUTH / USER ---------- */
const [session,setSession]=useState(null);
const [isAdmin,setIsAdmin]=useState(false);

/* ---------- CHAT ---------- */
const [chats,setChats]=useState([]);
const [currentChatId,setCurrentChatId]=useState(null);
const currentChat=chats.find(c=>c.id===currentChatId);
const [input,setInput]=useState('');
const [loading,setLoading]=useState(false);

/* ---------- UI ---------- */
const [showSidebar,setShowSidebar]=useState(window.innerWidth>768);
const [showSettings,setShowSettings]=useState(false);

/* ---------- SETTINGS ---------- */
const [apiKeys,setApiKeys]=useState({});
const [glassmorphism,setGlassmorphism]=useState(true);
const [gradient,setGradient]=useState(localStorage.getItem('glassGradient')||'aurora');

/* ---------- REFS ---------- */
const messagesEndRef=useRef(null);

/* ===================== EFFECTS ===================== */
useEffect(()=>{
  document.body.style.background=glassmorphism?gradients[gradient]:'#111827';
  localStorage.setItem('glassGradient',gradient);
},[gradient,glassmorphism]);

useEffect(()=>{
  supabase.auth.getSession().then(({data})=>{
    setSession(data.session);
    if(data.session)setIsAdmin(data.session.user.email===ADMIN_EMAIL);
  });
  supabase.auth.onAuthStateChange((_e,s)=>{
    setSession(s);
    if(s)setIsAdmin(s.user.email===ADMIN_EMAIL);
  });
},[]);

useEffect(()=>{
  messagesEndRef.current?.scrollIntoView({behavior:'smooth'});
},[currentChat?.messages]);

/* ===================== LOAD DATA ===================== */
const loadUserData=async(uid)=>{
  const {data:ch}=await supabase.from('chats')
    .select('*').eq('user_id',uid)
    .order('created_at',{ascending:false});
  if(ch?.length){setChats(ch);setCurrentChatId(ch[0].id);}
};

useEffect(()=>{
  if(session)loadUserData(session.user.id);
},[session]);

/* ===================== SEND MESSAGE ===================== */
const sendMessage=async()=>{
  if(!input.trim()||!currentChat)return;
  const model=models.find(m=>m.id===currentChat.model);
  const apiKey=apiKeys[model.provider];
  if(!apiKey){alert(`Missing ${model.provider} API key`);setShowSettings(true);return;}

  const userMsg={role:'user',content:input};
  const history=[...(currentChat.messages||[]),userMsg];
  setChats(chats.map(c=>c.id===currentChatId?{...c,messages:history}:c));
  setInput('');
  setLoading(true);

  let response='';

  try{
    if(model.provider==='mistral'){
      const r=await fetch('https://api.mistral.ai/v1/chat/completions',{
        method:'POST',
        headers:{Authorization:`Bearer ${apiKey}`,'Content-Type':'application/json'},
        body:JSON.stringify({model:model.endpoint,messages:history})
      });
      response=(await r.json()).choices[0].message.content;
    }

    if(model.provider==='alibaba'){
      const r=await fetch('https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation',{
        method:'POST',
        headers:{Authorization:`Bearer ${apiKey}`,'Content-Type':'application/json'},
        body:JSON.stringify({model:model.endpoint,input:{messages:history}})
      });
      response=(await r.json()).output.text;
    }

    /* ORIGINAL PROVIDERS (UNCHANGED) */
    if(['cerebras','groq','deepseek'].includes(model.provider)){
      const endpoint=model.provider==='cerebras'
        ?'https://api.cerebras.ai/v1/chat/completions'
        :model.provider==='groq'
        ?'https://api.groq.com/openai/v1/chat/completions'
        :'https://api.deepseek.com/chat/completions';

      const r=await fetch(endpoint,{
        method:'POST',
        headers:{Authorization:`Bearer ${apiKey}`,'Content-Type':'application/json'},
        body:JSON.stringify({model:model.endpoint,messages:history,max_tokens:4096})
      });
      response=(await r.json()).choices[0].message.content;
    }

    const tokens=estimateTokens(response);
    const assistantMsg={role:'assistant',content:response,tokens,model:model.name};
    const updated=[...history,assistantMsg];

    await supabase.from('chats').update({messages:updated}).eq('id',currentChatId);
    setChats(chats.map(c=>c.id===currentChatId?{...c,messages:updated}:c));

  }catch(e){alert(e.message);}
  finally{setLoading(false);}
};

/* ===================== RENDER CONTINUES IN PART 2 ===================== */

/* ===================== UI ===================== */
if(!session){
  return(
    <div className="h-screen flex items-center justify-center text-white">
      <div className="glass-card p-8 max-w-sm w-full text-center">
        <h2 className="text-xl mb-4">Login</h2>
        <AuthForm />
      </div>
    </div>
  );
}

return(
<div className="flex h-screen text-white">

{/* ===================== SIDEBAR ===================== */}
{showSidebar && (
<aside className="w-72 glass-dark p-4 flex flex-col">
  <button className="mb-4 glass-button py-2" onClick={async()=>{
    const {data}=await supabase.from('chats').insert({
      user_id:session.user.id,
      model:models[0].id,
      messages:[]
    }).select().single();
    setChats([data,...chats]);
    setCurrentChatId(data.id);
  }}>+ New Chat</button>

  <div className="flex-1 overflow-y-auto">
    {chats.map(c=>(
      <div key={c.id}
        className={`p-2 rounded cursor-pointer ${c.id===currentChatId?'bg-white/10':''}`}
        onClick={()=>setCurrentChatId(c.id)}>
        {c.model}
      </div>
    ))}
  </div>

  <button className="mt-4 underline" onClick={()=>setShowSettings(true)}>Settings</button>
</aside>
)}

{/* ===================== MAIN ===================== */}
<main className="flex-1 flex flex-col">

{/* Header */}
<header className="glass p-3 flex items-center gap-3">
  <button className="md:hidden" onClick={()=>setShowSidebar(!showSidebar)}>☰</button>
  <h1 className="font-semibold">Multi-AI Chat</h1>
  <div className="ml-auto text-xs opacity-70">
    Tokens used (chat): {
      currentChat?.messages?.reduce((a,m)=>a+(m.tokens||0),0) || 0
    }
  </div>
</header>

{/* Messages */}
<div className="flex-1 overflow-y-auto p-4 space-y-4 chat-scroll-area">
{currentChat?.messages?.map((m,i)=>(
  <div key={i} className={`max-w-3xl ${m.role==='user'?'ml-auto':''}`}>
    <div className="glass-card p-3">
      {m.role==='assistant'
        ?<div className="markdown-content"
            dangerouslySetInnerHTML={{__html:renderMarkdown(m.content)}}/>
        :<div>{m.content}</div>
      }
      {m.tokens && (
        <div className="text-xs opacity-60 mt-2 flex justify-between">
          <span>{m.tokens} tokens · {m.model}</span>
          <button className="underline" onClick={()=>copyToClipboard(m.content)}>
            Copy message
          </button>
        </div>
      )}
    </div>
  </div>
))}
<div ref={messagesEndRef}></div>
</div>

{/* Input */}
<footer className="glass p-3 flex gap-2">
  <textarea
    value={input}
    onChange={e=>setInput(e.target.value)}
    className="glass-input flex-1 p-2 rounded"
    placeholder="Type your message..."
    onKeyDown={e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}}}
  />
  <button onClick={sendMessage} className="glass-button px-4 flex items-center justify-center">
    {loading
      ?<div className="flex gap-1">
        <span className="animate-bounce-1">•</span>
        <span className="animate-bounce-2">•</span>
        <span className="animate-bounce-3">•</span>
      </div>
      :<SendIcon/>
    }
  </button>
</footer>

</main>

{/* ===================== SETTINGS ===================== */}
{showSettings && (
<div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
  <div className="glass-card p-6 max-w-xl w-full max-h-[90vh] overflow-y-auto">
    <h2 className="text-xl mb-4">Settings</h2>

    <label className="block mb-2">Glassmorphism</label>
    <input type="checkbox" checked={glassmorphism}
      onChange={e=>setGlassmorphism(e.target.checked)} />

    <label className="block mt-4 mb-2">Glass Gradient</label>
    <select value={gradient} onChange={e=>setGradient(e.target.value)}
      className="glass-input p-2 w-full rounded">
      {Object.keys(gradients).map(g=>(
        <option key={g} value={g}>{g}</option>
      ))}
    </select>

    <h3 className="mt-6 mb-2 font-semibold">API Keys</h3>
    {['google','cerebras','groq','deepseek','mistral','alibaba'].map(p=>(
      <input key={p}
        className="glass-input p-2 w-full rounded mt-2"
        placeholder={`${p} API key`}
        type="password"
        onChange={e=>setApiKeys({...apiKeys,[p]:e.target.value})}/>
    ))}

    <h3 className="mt-6 font-semibold">Usage</h3>
    <p className="text-sm opacity-70">
      Total tokens (current chat): {
        currentChat?.messages?.reduce((a,m)=>a+(m.tokens||0),0)||0
      }
    </p>

    <button className="glass-button mt-6 px-4 py-2"
      onClick={()=>setShowSettings(false)}>Close</button>
  </div>
</div>
)}

</div>
);
}

/* ===================== AUTH FORM ===================== */
function AuthForm(){
  const [email,setEmail]=useState('');
  const [password,setPassword]=useState('');
  return(
    <>
      <input className="glass-input p-2 w-full rounded mb-2"
        placeholder="Email" onChange={e=>setEmail(e.target.value)} />
      <input className="glass-input p-2 w-full rounded mb-4"
        type="password" placeholder="Password"
        onChange={e=>setPassword(e.target.value)} />
      <button className="glass-button px-4 py-2 w-full"
        onClick={()=>supabase.auth.signInWithPassword({email,password})}>
        Login
      </button>
    </>
  );
}

/* ===================== RENDER ===================== */
ReactDOM.createRoot(document.getElementById('app')).render(<App/>);

</script>
</body>
</html>
