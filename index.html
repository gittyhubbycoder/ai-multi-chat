<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-AI Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .animate-bounce-1 { animation: bounce 1s infinite 0ms; }
        .animate-bounce-2 { animation: bounce 1s infinite 150ms; }
        .animate-bounce-3 { animation: bounce 1s infinite 300ms; }
        .markdown-content h1 { font-size: 1.875rem; font-weight: bold; margin-top: 1.5rem; margin-bottom: 1rem; }
        .markdown-content h2 { font-size: 1.5rem; font-weight: bold; margin-top: 1.25rem; margin-bottom: 0.75rem; }
        .markdown-content h3 { font-size: 1.25rem; font-weight: bold; margin-top: 1rem; margin-bottom: 0.5rem; }
        .markdown-content p { margin-bottom: 1rem; }
        .markdown-content strong { font-weight: bold; }
        .markdown-content em { font-style: italic; }
        .markdown-content code { background: rgba(0,0,0,0.3); padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-family: monospace; font-size: 0.875rem; }
        .markdown-content pre { background: rgba(0,0,0,0.4); padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin-bottom: 1rem; }
        .markdown-content pre code { background: transparent; padding: 0; }
        .markdown-content ul { list-style: disc; margin-left: 1.5rem; margin-bottom: 1rem; }
        .markdown-content ol { list-style: decimal; margin-left: 1.5rem; margin-bottom: 1rem; }
        .markdown-content li { margin-bottom: 0.5rem; }
        .markdown-content a { color: #60a5fa; text-decoration: underline; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
    </style>
</head>
<body>
    <div id="app"></div>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        marked.setOptions({ breaks: true, gfm: true });

        // ⚠️ REPLACE WITH YOUR CREDENTIALS
        const SUPABASE_URL = 'https://dagyncvbqirgnydsxahf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhZ3luY3ZicWlyZ255ZHN4YWhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NzU0MTIsImV4cCI6MjA4MTA1MTQxMn0.SzYiLxkdrtjUEi4g-9FwwdWSpyUewfEqrSbazrNGW1E';
        const ADMIN_EMAIL = 'jasimd931@gmail.com';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const models = [
            { id: 'gemini-pro', name: 'Gemini 2.5 Pro', provider: 'google', endpoint: 'gemini-2.0-flash-exp' },
            { id: 'cerebras', name: 'Cerebras Llama 3.3 70B', provider: 'cerebras', endpoint: 'llama3.3-70b' },
            { id: 'groq', name: 'Groq Llama 3.3 70B', provider: 'groq', endpoint: 'llama-3.3-70b-versatile' },
            { id: 'deepseek', name: 'DeepSeek V3', provider: 'deepseek', endpoint: 'deepseek-chat' },
        ];

        const SendIcon = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>;
        const UserIcon = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
        const SettingsIcon = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6"/></svg>;
        const LogOutIcon = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>;
        const TrashIcon = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>;
        const PlusIcon = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
        const MessageIcon = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>;
        const EditIcon = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>;
        const ShieldIcon = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>;

        function App() {
            const [session, setSession] = useState(null);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isSignup, setIsSignup] = useState(false);
            const [chats, setChats] = useState([]);
            const [currentChatId, setCurrentChatId] = useState(null);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [apiKeys, setApiKeys] = useState({});
            const [showSettings, setShowSettings] = useState(false);
            const [showSidebar, setShowSidebar] = useState(true);
            const [editingChatId, setEditingChatId] = useState(null);
            const [editingName, setEditingName] = useState('');
            const [isAdmin, setIsAdmin] = useState(false);
            const messagesEndRef = useRef(null);

            const currentChat = chats.find(c => c.id === currentChatId);

            useEffect(() => {
                supabase.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                    if (session) {
                        setIsAdmin(session.user.email === ADMIN_EMAIL);
                        loadUserData(session.user.id);
                    }
                });

                supabase.auth.onAuthStateChange((_event, session) => {
                    setSession(session);
                    if (session) {
                        setIsAdmin(session.user.email === ADMIN_EMAIL);
                        loadUserData(session.user.id);
                    }
                });
            }, []);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [currentChat?.messages]);

            const loadUserData = async (userId) => {
                const { data: chatsData } = await supabase.from('chats').select('*').eq('user_id', userId).order('created_at', { ascending: false });
                if (chatsData?.length > 0) {
                    setChats(chatsData);
                    setCurrentChatId(chatsData[0].id);
                } else {
                    createNewChat(userId);
                }

                const { data: keysData } = await supabase.from('api_keys').select('*').eq('user_id', userId);
                const keysObj = {};
                keysData?.forEach(k => { keysObj[k.provider] = k.key_value; });
                setApiKeys(keysObj);
            };

            const createNewChat = async (userId) => {
                const { data } = await supabase.from('chats').insert([{ 
                    user_id: userId || session.user.id, 
                    name: 'New Chat', 
                    model: 'cerebras', 
                    messages: [] 
                }]).select().single();
                if (data) {
                    setChats([data, ...chats]);
                    setCurrentChatId(data.id);
                }
            };

            const deleteChat = async (chatId) => {
                if (chats.length === 1) { alert("Can't delete last chat!"); return; }
                if (!confirm('Delete this chat?')) return;
                await supabase.from('chats').delete().eq('id', chatId);
                const newChats = chats.filter(c => c.id !== chatId);
                setChats(newChats);
                if (currentChatId === chatId) setCurrentChatId(newChats[0]?.id);
            };

            const renameChat = async (chatId, newName) => {
                await supabase.from('chats').update({ name: newName }).eq('id', chatId);
                setChats(chats.map(c => c.id === chatId ? { ...c, name: newName } : c));
                setEditingChatId(null);
            };

            const updateChatModel = async (model) => {
                await supabase.from('chats').update({ model }).eq('id', currentChatId);
                setChats(chats.map(c => c.id === currentChatId ? { ...c, model } : c));
            };

            const handleAuth = async () => {
                try {
                    if (isSignup) {
                        const { error } = await supabase.auth.signUp({ email, password });
                        if (error) throw error;
                        alert('Account created! Please log in.');
                        setIsSignup(false);
                    } else {
                        const { error } = await supabase.auth.signInWithPassword({ email, password });
                        if (error) throw error;
                    }
                } catch (error) {
                    alert(error.message);
                }
            };

            const sendMessage = async () => {
                if (!input.trim() || !currentChat) return;

                const model = models.find(m => m.id === currentChat.model);
                const apiKey = apiKeys[model.provider];

                if (!apiKey) {
                    alert(`Please add ${model.provider} API key in settings`);
                    setShowSettings(true);
                    return;
                }

                const userMsg = { role: 'user', content: input, timestamp: new Date().toISOString() };
                const newMsgs = [...(currentChat.messages || []), userMsg];
                
                setChats(chats.map(c => c.id === currentChatId ? { ...c, messages: newMsgs } : c));

                if ((!currentChat.messages || currentChat.messages.length === 0) && currentChat.name === 'New Chat') {
                    const chatName = input.slice(0, 30) + (input.length > 30 ? '...' : '');
                    await supabase.from('chats').update({ name: chatName }).eq('id', currentChatId);
                    setChats(chats.map(c => c.id === currentChatId ? { ...c, name: chatName } : c));
                }

                setInput('');
                setLoading(true);

                try {
                    const history = newMsgs.map(m => ({ role: m.role === 'assistant' ? 'assistant' : 'user', content: m.content }));
                    let response;

                    if (model.provider === 'google') {
                        const contents = history.map(msg => ({
                            role: msg.role === 'user' ? 'user' : 'model',
                            parts: [{ text: msg.content }]
                        }));
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model.endpoint}:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents })
                        });
                        const data = await res.json();
                        response = data.candidates[0].content.parts[0].text;
                    } else if (model.provider === 'cerebras') {
                        const res = await fetch('https://api.cerebras.ai/v1/chat/completions', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                            body: JSON.stringify({ model: model.endpoint, messages: history, max_tokens: 4096 })
                        });
                        const data = await res.json();
                        response = data.choices[0].message.content;
                    } else if (model.provider === 'groq') {
                        const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                            body: JSON.stringify({ model: model.endpoint, messages: history, max_tokens: 4096 })
                        });
                        const data = await res.json();
                        response = data.choices[0].message.content;
                    } else if (model.provider === 'deepseek') {
                        const res = await fetch('https://api.deepseek.com/chat/completions', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                            body: JSON.stringify({ model: model.endpoint, messages: history, max_tokens: 4096 })
                        });
                        const data = await res.json();
                        response = data.choices[0].message.content;
                    }

                    const assistantMsg = { role: 'assistant', content: response, timestamp: new Date().toISOString() };
                    const updatedMsgs = [...newMsgs, assistantMsg];

                    await supabase.from('chats').update({ messages: updatedMsgs }).eq('id', currentChatId);
                    setChats(chats.map(c => c.id === currentChatId ? { ...c, messages: updatedMsgs } : c));
                } catch (error) {
                    alert('Error: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            if (!session) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900">
                        <div className="bg-gray-800 p-8 rounded-2xl w-96 border border-gray-700">
                            <div className="text-center mb-8">
                                <div className="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                                    <UserIcon />
                                </div>
                                <h1 className="text-3xl font-bold text-white mb-2">Multi-AI Chat</h1>
                                <p className="text-gray-400">Your personal AI platform</p>
                            </div>
                            <div className="space-y-4">
                                <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="Email"
                                    className="w-full bg-gray-700 text-white px-4 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="Password"
                                    onKeyPress={(e) => e.key === 'Enter' && handleAuth()}
                                    className="w-full bg-gray-700 text-white px-4 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                <button onClick={handleAuth} className="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold">
                                    {isSignup ? 'Sign Up' : 'Login'}
                                </button>
                                <button onClick={() => setIsSignup(!isSignup)} className="w-full text-blue-400 hover:text-blue-300 text-sm">
                                    {isSignup ? 'Have an account? Login' : 'Need an account? Sign up'}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (showSettings) {
                return <SettingsScreen apiKeys={apiKeys} setApiKeys={setApiKeys} setShowSettings={setShowSettings} session={session} />;
            }

            return (
                <div className="flex h-screen bg-gray-900 text-white">
                    <div className={`${showSidebar ? 'w-64' : 'w-0'} bg-gray-800 border-r border-gray-700 flex flex-col transition-all overflow-hidden`}>
                        <div className="p-4 border-b border-gray-700">
                            <button onClick={() => createNewChat()} className="w-full bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg flex items-center justify-center gap-2">
                                <PlusIcon /> New Chat
                            </button>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto custom-scrollbar p-2">
                            {chats.map(chat => (
                                <div key={chat.id} className={`p-3 mb-2 rounded-lg cursor-pointer group ${currentChatId === chat.id ? 'bg-gray-700' : 'hover:bg-gray-750'}`} 
                                    onClick={() => setCurrentChatId(chat.id)}>
                                    <div className="flex items-center justify-between">
                                        {editingChatId === chat.id ? (
                                            <input type="text" value={editingName} onChange={(e) => setEditingName(e.target.value)}
                                                onBlur={() => renameChat(chat.id, editingName)}
                                                onKeyPress={(e) => e.key === 'Enter' && renameChat(chat.id, editingName)}
                                                className="bg-gray-600 px-2 py-1 rounded text-sm flex-1" autoFocus
                                                onClick={(e) => e.stopPropagation()} />
                                        ) : (
                                            <>
                                                <div className="flex items-center gap-2 flex-1 min-w-0">
                                                    <MessageIcon /><span className="text-sm truncate">{chat.name}</span>
                                                </div>
                                                <div className="flex gap-1 opacity-0 group-hover:opacity-100">
                                                    <button onClick={(e) => { e.stopPropagation(); setEditingChatId(chat.id); setEditingName(chat.name); }}
                                                        className="p-1 hover:bg-gray-600 rounded"><EditIcon /></button>
                                                    <button onClick={(e) => { e.stopPropagation(); deleteChat(chat.id); }}
                                                        className="p-1 hover:bg-gray-600 rounded"><TrashIcon /></button>
                                                </div>
                                            </>
                                        )}
                            
